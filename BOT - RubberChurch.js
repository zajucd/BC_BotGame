//#region 地图与bio
const map = {
    "Type": "Always",
    "Tiles": "КККККККККККККККККККККККККККККККККККККККККnnnnsКsnnКККККëëëëКККККnnsКsnnnnКККnnnnnКnnnКnnКëëëëКnnКnnnКnnnnnККККККnnКnnnКnКККëëëëКККnКnnnКnnККККККnnnnnКnnnКnnКëëëëëëëëëКnnКnnnКnnnnnКККnnnnnКnnnКnКККëëëëëëëëëКККnКnnnКnnnnnККККККnnКnnnКnnКëëëëëëëëëКnnКnnnКnnККККККnnnnnКnnnКnКККëëëëëëëëëКККnКnnnКnnnnnКККnnnnnКККККnnКëëëëëëëëëКnnКККККnnnnnККККККnnККnКККëëëëëëëëëКККnККnnККККККnnnnnККnnКëëëëëëëëëКnnККnnnnnКККnnnnnККnКККëëëëëëëëëКККnККnnnnnКККККККККККККККККККККККККККККККККККККККККККnnnКnnnnnnnnnКnnnnnnnnnКnnnnnnnnnКnnnКККnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnКККnnnКnnКnКnКnnКnnnnnnnnnКnnКnКnКnnКnnnКККККККnnnКnnnКККККККККККnnnКnnnКККККККККnnКККККnnККnnКККККnnКККККnnnКnnnККККККnnnКnnnКККККnnКnКnКnnККnnКnКnКnnКККККККnnnnnnnnnККnКККККnККnnnnnnnnnКККККnnnnnnnnnККnККnККnnnnnnnnnКККККККККККККККККККККККККККККККККККККККККÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒКККККÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒКККККÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒКККККККККÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒККККККnnnnК×ÒÒÒÒÒÒߚÒÒÒÒÒÒÒÒÒÒÒÒÒߚÒÒÒÒÒÒ×КnnnnКnnnnКÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒÒКnnnnКККККККККККККККККККККККККККККККККККККККККddddddddddddddddddddddddddddddddddddddddddddddddddddddddКККККККdddddddddddddddddddddddddddddddddКssssКdddddddddddddddddddddddddddddddddКsssssКddddddddddddddddddddddddddddКККККККККККККККККdddddddddddddddddddddddКККææææææææææКdddddddddddddddddddddddКККææææææææææКdddddddddddddddddddddddІККææææææææææКdddddddddddddddddddddddККККККææææææææææКdddddddddddddddddddddddККККККææææææææææКdddddddddddd",
    "Objects": "dೆೆೆddddddddddddddddddddddddddddddௌೆೆೆddddddddddߚߚddజddd߮dߚdߚd߮dddదddߚߚddddddddddddddddddddddddd߮ddddd߮ddddddddddddddddddೆೆೆddddddddజddd߮dÒÒÒd߮dddదddddddddೆೆೆdddddddddߚߚdddddddddd߮ddddddddddߚߚddddddddddddddddddddజdddddd߮ddddddదddddddddddddddೆೆೆddddиddddddd߮dddddddиddddೆೆೆddddddddddddddజdddddd߮ddddddదddddddddddddddddddddddddddddd߮ddddddddddddddddddೆೆೆÒdddddddజdddddd߮ddddddదdddddddÒೆೆೆdddddddddddddddddd߮ddddddddddddddddddddddddd dddddddddd߮dddddddddd¢ddddddddddd௖ddྪ௖dྪ௪dྪ௖dddddྭdྮddddd௖ྪd௪ྪd௖ྪdd௖ddddddߚddddddddddddddd߮dddddddddddddddߚddddddddddddddddddddddd߮ddddddddddddddddddddddddddddࠖdࠖdddddddd߮ddddddddࠖdࠖdddddddddddྪddddࠖdddࠖdddd௠ddddd௠ddddࠖdddࠖddddྪdddூdddddddddddddddddd߮ddddddddddddddddddூddddddddࠖdddࠖddddd௠d߮d௠dddddࠖdddࠖddddddddddddddddࠖdࠖdddddddd߮ddddddddࠖdࠖdddddddddூdddddddddddddddࠖdddddࠖdddddddddddddddூdddddddddddddddddddd¤dddddddddddddddddddddddddd௠dddddྪdddྶdddddྶdddྪdddddddddddddூdddddddddddddddddʔ߮ʔdddddddddddddddddூddddddd߸d߸d߸d߸d߸dddʔ߮ʔddd߸d߸d߸d߸d߸dddddddddddddddddddddddddʔ߮ʔdddddddddddddddddddddྯdddddddddddddddʔ߮ʔdddddddddddddddྯಀddЮdddddddߤdddddddddʔ߮ʔdddddddddߤdddddddЮdddddddddddddddddddd߮ddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddߚdߚddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddྴdddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddsdddddddddddddddddddddddddddddddddddddddndddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd"
}
const BlankObjId = 100;
const MetalDoorObjId = 4020;
const IronBarsObjId = 2030;

const desc = `
BOT game：RubberChurch
作者: zajucd(7092)
原型: https://github.com/keykey5/BC-BOT-repository
发布地址: https://github.com/zajucd/BC_BotGame

欢迎加入双姊妹修会
你是否对繁杂的尘世感到厌倦？你是否渴望一段充实的人生？
加入双姊妹修会，为缔造更加美好的世间贡献一份力量。
感受双姊妹之福音，接受完环福音与缺环福音的救赎
有意向加入者请到XXX街XXX栋来开始[start]一段新的人生。



双姊妹修会守则
1.双姊妹为成为世界之根基立下了永不相见的誓言，作为双姊妹的追随者应当效仿双姊妹，完环修会所属修女不得进入缺环修会，缺环修会所属修女不得进入完环修会

2.双姊妹为成为世界之根基立下了永恒静默的誓言，作为双姊妹的追随者应当效仿双姊妹，一日之内不得擅自多次发言。

3.双姊妹为成为世界之根基立下了永久劳苦的誓言，作为双姊妹的追随者应当效仿双姊妹，每日日间会为修女分配一次工作，修女通过完成工作积累虔诚，不得怠慢工作。

4.双姊妹为成为世界之根基立下了永远纯洁的誓言，作为双姊妹的追随者应当效仿双姊妹，每日傍晚会进行礼拜，期间修女可检举其他违反了规则的修女。

5.作为双姊妹的追随者应当时刻保持对双姊妹最大限度的崇敬，若未得到双姊妹亲自赐福者绝不允许踏入双姊妹像下方。

6.双姊妹的追随者会在恍惚中获得真正的自我。

7.双姊妹的追随者会在恍惚中迎来新生。

8.受到惩罚的双姊妹的追随者当在惩罚室中通过苦修来获得宽恕


以下是守则的人话版本
1.进入栏杆后区域或在夜间离开寝房区域会违反规则(违反规则不会直接受到惩罚)

2.根据等级，游戏内只能发言5，7，9次，超出次数的发言会受到惩罚，每次睡觉会重置次数(发言，星号开头发言，动作文本均会计数，如果安装了有自动发言功能的插件可能会被BOT肘击)

3.游戏内每日白天一次工作，完成获得经验值，未完成会违反规则

4.游戏内每日傍晚传送至礼拜堂，可在这里检举违反规则的修女，检举成功会获得经验值，被检举者会受到惩罚

5.等级未达到lv3(高阶修女)的话移动到雕像下方的格子的话会受到惩罚

6.游戏内每日礼拜后可前往寝床区域入眠，若经验值达到指定值(一般为3)会升级，达到lv2(正式修女)时会获得身份，完成身份目标可以观看身份对应的结局

7.积累移动两百步会进入疲劳状态，移动速度大幅下降，每日礼拜后可前往寝床区域入眠可解除疲劳状态

8.如果受到惩罚会被扔到惩罚室跑圈，每次多跑十圈

9.可用使用[/bot (指令) (参数)]的格式来执行行动，例: /bot start 的指令为开始游戏， /bot report zajucd 的指令为在礼拜阶段检举名为zajucd的玩家的违规行为。

可用指令
[start]在房间入口前方小房间内的乳胶格子上开始游戏
[think]检查当前状态
[check]检查当前所在位置
其余指令会在游戏内以方括号提示


`
//#endregion
//#region 装备
const baseEquips = [
    
    {
        "Item": "FuturisticBra2",
        "AssetGroup": "ItemBreast",
        "Name": "圣洁之心",
        "Description": "守住己身己心罢，祂说，于是众门徒便着上了永不锈蚀的胸铠。",
        "Color": "#FF88FF,Default,#585858,Default,#404040,Default",
        "Lock": "HighSecurityPadlock",
        "Private": false,
        "ItemProperty": {},
        "Type": null,
        "Property": "Normal",
        "TypeRecord": { d: 0, s: 0 },
        "MemberName": "zajucd",
        "MemberNumber": 7092
    },
    {
        "Item": "BalletMittens",
        "AssetGroup": "ItemBoots",
        "Name": "圣洁之履",
        "Description": "勿擅行，祂说，于是众门徒便并了双腿，封了双足。",
        "Color": "#505050,#606060,#404040,Default,#000000,#797979,#404040",
        "Lock": "HighSecurityPadlock",
        "Private": false,
        "ItemProperty": {},
        "Type": null,
        "Property": "Heavy",
        "TypeRecord": { p: 1 },
        "MemberName": "zajucd",
        "MemberNumber": 7092
    },
    {
        "Item": "LatexCatsuit",
        "AssetGroup": "Suit",
        "TypeRecord": {
            "typed": 0
        },
        "Color": "#292929,#808080,#808080,#808080",
        "Text": "",
        "Text2": "#7092",
        "Text3": ""
    },
    {
        "Item": "LatexCatsuit",
        "AssetGroup": "SuitLower",
        "TypeRecord": {
            "typed": 0
        },
        "Color": "#292929,#808080,#808080",
        "Text": "",
        "Text2": "#7092",
        "Text3": ""
    },
    {
        "Item": "NunRobes",
        "AssetGroup": "Cloth",
        "TypeRecord": {
            "typed": 0
        },
    },
    {
        "Item": "ShinyArmbinder",
        "AssetGroup": "ItemArms",
        "Name": "圣洁祷告",
        "Description": "时刻心系吾，吾与尔等同在，祂说，于是众门徒便将双臂封于身后，永世作祈祷状。",
        "Color": "Default,Default,Default,Default",
        "Lock": "HighSecurityPadlock",
        "Private": false,
        "ItemProperty": {},
        "Type": null,
        "Property": "Normal",
        "TypeRecord": { typed: 2 },
        "MemberName": "zajucd",
        "MemberNumber": 7092
    },
    {
        "Item": "FuturisticChastityBelt",
        "AssetGroup": "ItemPelvis",
        "Name": "圣洁之贞",
        "Description": "莫让邪祟染了尔的身，祂说，于是众门徒便封闭了身体的一切孔洞。",
        "Color": "#585858,#FF88FF,Default,Default,Default,Default,#222222,Default,Default",
        "Lock": "HighSecurityPadlock",
        "Private": false,
        "ItemProperty": {},
        "Type": null,
        "Property": "Normal",
        "TypeRecord": { m: 3, f: 1, b: 1, t: 2, o: 1 },
        "MemberName": "zajucd",
        "MemberNumber": 7092
    },
    {
        "Item": "LatexRespirator",
        "AssetGroup": "ItemMouth3",
        "Name": "圣洁之息",
        "Description": "大气是不洁的，祂说，于是众门徒便接上了载有祂气息的容器。",
        "Color": "#333333,#222222,#bbbbbb,#222222,#808080,#FF88FF",
        "Lock": "HighSecurityPadlock",
        "Private": false,
        "ItemProperty": {},
        "Type": null,
        "Property": "Normal",
        "TypeRecord": { f: 2, g: 1, s: 0, m: 2, l: 1 },
        "MemberName": "zajucd",
        "MemberNumber": 7092
    },
]

const leftEquips = [
    {
        "Item": "DroneMask",
        "AssetGroup": "ItemHead",
        "Name": "圣洁之面",
        "Description": "吾将化为二身，其一为全之环，祂说，于是众门徒便封了面部，刻了全环之印。吾言尽于此，祂语毕便化做了■和她。众门徒褪了茧，供奉起她，传播全环福音。",
        "Color": "#222222,#CCCCCC,#FF88FF,#00F4FD,#E700CA,Default",
        "Lock": "HighSecurityPadlock",
        "Private": false,
        "ItemProperty": {},
        "TypeRecord": {
            m: 0,
            e: 0,
            p: 9,
            g: 3,
            s: 1,
            h: 1,
            j: 2,
            b: 0
        },
        "Property": "Normal",
        "MemberName": "zajucd",
        "MemberNumber": 7092
    }
]

const rightEquips = [
    {
        "Item": "DroneMask",
        "AssetGroup": "ItemHead",
        "Name": "圣洁之面",
        "Description": "吾将化为二身，其一为缺之环，祂说，于是众门徒便封了面部，刻了缺环之印。吾言尽于此，祂语毕便化做了她和■。众门徒褪了茧，供奉起她，传播缺环福音。",
        "Color": "#222222,#CCCCCC,#FF88FF,#00F4FD,#E700CA,Default",
        "Lock": "HighSecurityPadlock",
        "Private": false,
        "ItemProperty": {},
        "TypeRecord": {
            m: 0,
            e: 0,
            p: 10,
            g: 3,
            s: 1,
            h: 1,
            j: 2,
            b: 0
        },
        "Property": "Normal",
        "MemberName": "zajucd",
        "MemberNumber": 7092
    }
]

const lv1Hat = [
    {
        "Item": "LatexHabit",
        "AssetGroup": "Hat",
        "Color": "Default,Default,Default,Default",
        "TypeRecord": {
            "typed": 0
        },
    }
]

const lv2Hat = [
    {
        "Item": "NunHabit",
        "AssetGroup": "Hat",
        "Color": "#FFFFFF,#272727,#FFFFFF,#EF9C00",
        "TypeRecord": {
            "typed": 0
        },
    }
]

const lv3Hat = [
    {
        "Item": "NunVeil",
        "AssetGroup": "Hat",
        "Color": "#FFFFFF,#272727,#FFFFFF",
        "TypeRecord": {
            "typed": 0
        },
    }
]

const hatList = [lv1Hat, lv2Hat, lv3Hat];

const SleepEquips = [
    {
        "Item": "InflatableBodyBag",
        "AssetGroup": "ItemDevices",
        "Name": "圣洁之茧",
        "Description": "随我来罢，祂说，于是迷茫者们结了茧，成了祂的门徒。",
        "Color": "Default",
        "Lock": "HighSecurityPadlock",
        "Private": false,
        "ItemProperty": {},
        "Type": null,
        "TypeRecord": { typed: 0 },
        "Property": "Normal",
        "MemberName": "zajucd",
        "MemberNumber": 7092
    },
    {
        "Item": "CustomBallHood",
        "AssetGroup": "ItemHood",
        "Name": "圣洁之茧",
        "Description": "随我来罢，祂说，于是迷茫者们结了茧，成了祂的门徒。",
        "Color": "#222222, #CCCCCC, #EF870C, #CCCCCC, #F9EC0C, #CCCCCC",
        "Lock": "HighSecurityPadlock",
        "Private": false,
        "ItemProperty": {},
        "Type": null,
        "TypeRecord": { typed: 0 },
        "Property": "Normal",
        "MemberName": "zajucd",
        "MemberNumber": 7092
    },
    {
        "Item": "CeilingChain",
        "AssetGroup": "ItemAddon",
        "Name": "圣洁之茧",
        "Description": "随我来罢，祂说，于是迷茫者们结了茧，成了祂的门徒。",
        "Color": "Default",
        "Lock": "HighSecurityPadlock",
        "Private": false,
        "ItemProperty": {},
        "Type": null,
        "TypeRecord": {
            "typed": 2
        },
        "Property": "Normal",
        "MemberName": "zajucd",
        "MemberNumber": 7092
    }
]

const EndEquips = [
    {
        "Item": "TheDisplayFrame",
        "AssetGroup": "ItemDevices",
        "Name": "圣洁之构",
        "Description": "救救我，她们说，然而没有人听到。",
        "Color": "Default",
        "Lock": "HighSecurityPadlock",
        "Private": false,
        "ItemProperty": {},
        "Property": "Normal",
        "MemberName": "zajucd",
        "MemberNumber": 7092
    }
]

const OutEquips = [
    {
        "Item": "ConcealingCloak",
        "AssetGroup": "ItemDevices",
        "Name": "圣洁之衣",
        "Description": "救救我，她们说，于是第十三个门徒背叛了祂。",
        "Color": "Default",
        "Lock": "HighSecurityPadlock",
        "Private": false,
        "ItemProperty": {},
        "Property": "Normal",
        "MemberName": "zajucd",
        "MemberNumber": 7092
    }
]

//#endregion
//#region 指令关键词
const CmdWords = ["Check", "Think", "Gather", "Take", "Put", "Enter", "Confess", "Report", "Contact", "MessUp", "Search","Sleep"];
//#endregion
//#region 基础区域
const leftBaseZone = { leftUp: { X: 0, Y: 1 }, rightDown: { X: 18, Y: 28 } };

const rightBaseZone = { leftUp: { X: 20, Y: 1 }, rightDown: { X: 39, Y: 28 } };

function BaseZoneMoved(player, areaInfo) {
    if (player.punishing == false && player.breakedRule == false) {
        if (globalInfo.phase == 1 && (IsInArea(player.Pos, leftBedRoomZone) || IsInArea(player.Pos, rightBedRoomZone)) == false) {
            player.breakedRule = true;
            SendText("在夜间外出，若被发现并检举会受到惩罚.", player);
            return;
        }
        //
        if (player.isLeft != areaInfo.isLeft) {
            player.breakedRule = true;
            SendText("进入了对方修会的领地，若被发现并检举会受到惩罚.", player);
            return;
        }
    }
    if (player.punishing == true && IsInArea(player.Pos, punishmentRoomZone) == false) {
        var targetTile = player.isLeft ? leftpunishmentRoomTiles[0] : rightpunishmentRoomTiles[0];
        Teleport(player, targetTile.X, targetTile.Y);
    }
    else if (globalInfo.phase == 3 && IsInArea(player.Pos, churchZone) == false && player.punishing == false) {
        var targetTile = player.isLeft ? leftchurchTPTile : rightchurchTPTile;
        Teleport(player, targetTile.X, targetTile.Y);
    }
    
}

const baseAreaArray = ["leftBaseZone", "rightBaseZone"]
//#endregion
//#region 图书馆
const leftLibraryZone = { leftUp: { X: 1, Y: 1 }, rightDown: { X: 5, Y: 11 } };

const leftLibraryBookZone = { leftUp: { X: 1, Y: 1 }, rightDown: { X: 3, Y: 10 } };

const leftLibraryTableTile = { X: 4, Y: 9 };

const leftLibraryHiddenOutTile = { X: 5, Y: 1 };

const leftLibraryHiddenInTile = { X: 7, Y: 1 };

const leftLibraryHiddenCageTile = { X: 8, Y: 6 };

const leftLibraryHiddenRoomZone = { leftUp: { X: 7, Y: 1 }, rightDown: { X: 9, Y: 7 } };


const rightLibraryZone = { leftUp: { X: 33, Y: 1 }, rightDown: { X: 38, Y: 11 } };

const rightLibraryBookZone = { leftUp: { X: 35, Y: 1 }, rightDown: { X: 38, Y: 10 } };

const rightLibraryTableTile = { X: 34, Y: 9 };

const rightLibraryHiddenOutTile = { X: 33, Y: 1 };

const rightLibraryHiddenInTile = { X: 31, Y: 1 };

const rightLibraryHiddenCageTile = { X: 30, Y: 6 };

const rightLibraryHiddenRoomZone = { leftUp: { X: 29, Y: 1 }, rightDown: { X: 31, Y: 7 } };

function LibraryZoneCheck(player, params, areaInfo) {
    SendText("这里是图书馆，藏书几乎全是双姊妹修会相关的书籍，因为修女无法使用双臂与双眼，所以藏书与其说是书不如说某种将信息输入大脑的装置，正式修女会在这里工作.", player);
    if (player.role == "heresy") {
        if (player.roleProcess == null) {
            player.roleProcess = [];
        }
        var find = player.roleProcess.find((a) => a.day == player.daySpend && a.isLeft == areaInfo.isLeft);
        if (find == undefined) {
            globalInfo.messageFoundBoost = true;
            player.roleProcess.push({ day: player.daySpend, isLeft : areaInfo.isLeft });
            SendText("你翻阅这里的书籍，找到了一些被修会隐藏的信息，其中有些甚至对于当今的教义来说是极其亵渎的，像这样让知识流入大脑让你感觉有些头痛.", player);
            var countL = 0;
            var countR = 0;
            for (var i of player.roleProcess) {
                if (i.isLeft == true) countL++;
                if (i.isLeft == false) countR++;
            }
            var count = countL + countR;
            switch (count) {
                case 1: {
                    SendText("有一对双胞胎被抛弃在了修会的门口，那不称职的亲人只留下了写着孩子名字的字条，姐姐叫福尔，妹妹叫斯斌莉。这不是修会第一次接收弃婴，恐怕也不会是最后一次.", player);
                }
                    break;
                case 2: {
                    SendText("福尔和斯斌莉,这两个孩子有些......异于常人，不是心理上而是身体上的，不可能有人的血液是黑色而粘稠的.", player);
                }
                    break;
                case 3: {
                    SendText("那两个孩子都快比我高了，而她们特殊的体质也越来越突出，她们不只是血液，其他体液也开始变成了黑色粘液.", player);
                }
                    break;
                case 4: {
                    SendText("那黑色粘液，不，那墨色的圣水引起了奇迹.", player);
                }
                    break;
                case 5: {
                    SendText("福尔，斯斌莉，我的福音，我的圣女。我知道你们有所不愿，但新的时代必将到来，我会为你们准备好这一切.", player);
                }
                    break;
            }
            if (countL >= 3 && countR >= 3) {
                ToEnd(player, "heresy");
            }
        }
        else {
            SendText("你今天在这里调查过了，再调查可能会引人耳目.", player);
        }
    }
}

function LibraryBookZoneTake(player, params, areaInfo) {
    if (player.currentJob != "library") {
        SendText("你今天没有整理藏书的工作，还是别乱动藏书了.", player);
        return;
    }
    var xDiff = player.Pos.X - areaInfo.area.leftUp.X;
    var yDiff = player.Pos.Y - areaInfo.area.leftUp.Y;
    var index = Math.floor(yDiff / 3) * 3 + xDiff + 1;
    player.currentJobProcess.taked = index;
    SendText("你背过身去用以背祷式缚在身后的手碰了一下藏书，那本书便被吸附在了你的手上.", player);
}
function LibraryBookZonePut(player, params, areaInfo) {
    if (player.currentJob != "library") {
        SendText("你今天没有整理藏书的工作，还是别乱动藏书了.", player);
        return;
    }
    var xDiff = player.Pos.X - areaInfo.area.leftUp.X;
    var yDiff = player.Pos.Y - areaInfo.area.leftUp.Y;
    var index = Math.floor(yDiff / 3) * 3 + xDiff + 1;
    var i = player.currentJobProcess.targets.findIndex((a) => a.from == player.currentJobProcess.taked && a.to == index);
    if (i == -1) {
        SendText("似乎不应该把这本书放到这里.", player);
    }
    else {
        player.currentJobProcess.targets.splice(i, 1);
        SendText("你将这本书放到了对应的位置.", player);

        var random = Math.floor(Math.random() * 100);
        if ((random < 5 && globalInfo.messageFoundBoost == false) || (random < 15 && globalInfo.messageFoundBoost == true)) {
            var str = "";
            random = Math.floor(Math.random() * 3);
            switch (random) {
                case 0: {
                    str = "全环修会的门之密语为46554c4c."
                }
                    break;
                case 1: {
                    str = "缺环修会的门之密语为53504c4954."
                }
                    break;
                case 2: {
                    str = "吾等全环圣女之名讳为福尔."
                }
                    break;
                case 3: {
                    str = "吾等缺环圣女之名讳为斯斌莉."
                }
                    break;
            }
            SendText("那本书上传出一声杂音，你听见了不久前来过这里的某人的低语:" + str, player);
        }
    }
}
function LibraryTableTileCheck(player, params, areaInfo) {
    if (player.currentJob != "library") {
        SendText("你今天没有整理藏书的工作，还是别乱动藏书了.", player);
        return;
    }
    var hintStr = "";
    for (var i of player.currentJobProcess.targets) {
        hintStr += i.from.toString() + "->" + i.to.toString() + " "
    }
    SendText("书桌上的面板显示了你今天需要整理的藏书：" + hintStr + ".", player);
}
function LibraryHiddenOutTileCheck(player, params, areaInfo) {
    if (params.length <= 0) {
        SendText("这里的墙壁让你感到有些违和，当你靠近时有一阵声音传进你的脑海:“献上门之密语罢”[使用[check 密语]指令].", player);
        return;
    }
    if ((areaInfo.isLeft == true && params[0] == "46554c4c") || (areaInfo.isLeft == false && params[0] == "53504c4954")) {
        SendText("墙壁缓缓地旋转，你来到了一间密室.", player);
        if (areaInfo.isLeft) {
            Teleport(player, leftLibraryHiddenInTile.X, leftLibraryHiddenInTile.Y)
        }
        else {
            Teleport(player, rightLibraryHiddenInTile.X, rightLibraryHiddenInTile.Y)
        }
    }
    else {
        SendText("密语错误.", player);
    }
}

function LibraryHiddenOutTileSearch(player, params, areaInfo) {
    if (player.role == "journalist") {
        player.breakedRule = true;
        SendText("这里似乎有扇暗门，你在附近仔细调查，找到了一行小字“全：FULL，缺：SPLIT 变：ASCII”.", player);
    }
}
function LibraryHiddenInTileCheck(player, params, areaInfo) {
    SendText("墙壁缓缓地旋转，你离开了密室.", player);
    if (areaInfo.isLeft) {
        Teleport(player, leftLibraryHiddenOutTile.X, leftLibraryHiddenOutTile.Y)
    }
    else {
        Teleport(player, rightLibraryHiddenOutTile.X, rightLibraryHiddenOutTile.Y)
    }
}

function LibraryHiddenCageTileCheck(player, params, areaInfo) {
    if (player.role == "lamb") {
        SendText("这便是你将献身的祭坛了，与你的姐妹一同进入[enter]成为开启门的祭品吧.", player);
    }
    else {
        SendText("这个令人毛骨悚然的笼子刚好可以容纳一个人进入[enter]，老实说你不觉得进去后还能出来.", player);
    }
}

function LibraryHiddenCageTileEnter(player, params, areaInfo) {
    if (player.punishing == false) {
        SendText("你站了进去，笼子自动关上了，再也没有离开的办法.", player);
        player.punishing = true;
        WearEquips(player, EndEquips);
        globalInfo.cagePlayers.push(player);
        if (globalInfo.cagePlayers.length >= 2) {
            for (var p of globalInfo.cagePlayers) {
                SendCageText(p);
            }
            var opers = [];
            for (var v of punishmentRoomHiddenDoorTiles) {
                opers.push({ X: v.X, Y: v.Y, Id: MetalDoorObjId })
            }
            SetMapObjs(opers);
        }
    }
    else {
        SendText("笼子已经闭合，你只能被囚禁在这里.", player);
    }
    

}

async function SendCageText(player) {
    await SendText("笼子突然收紧了，让你难以呼吸，同时你感觉体内有什么东西正在被抽走.", player);
    await SendText("你感到脚下的地板穿来一阵震动，你犹如天启般的知道了，惩罚室内的隐藏门打开了.", player);
    await SendText("虽然笼子的紧勒意外地让你感到有些舒服，但你明显得感受到自己真正变得虚弱，可能在日出之前你就会撑不住吧.", player);
    await SendText("快感与痛苦让你感到意识模糊，你只能希望自己的牺牲并非无用.", player);
}
function LibraryHiddenRoomZoneCheck(player, params, areaInfo) {
    SendText("你从未想到过图书馆内竟然有一间这样的密室，你清晰地感受到堆在这里的雕像的视线甚至是气息，在深处有一个笼子，散发着瘆人的气场.", player);
}


const LibraryAreaArray = ["leftLibraryZone", "leftLibraryBookZone", "leftLibraryTableTile", "leftLibraryHiddenOutTile", "leftLibraryHiddenInTile", "leftLibraryHiddenCageTile", "leftLibraryHiddenRoomZone", "rightLibraryZone", "rightLibraryBookZone", "rightLibraryTableTile", "rightLibraryHiddenOutTile", "rightLibraryHiddenInTile", "rightLibraryHiddenCageTile", "rightLibraryHiddenRoomZone"]
//#endregion
//#region 寝室
const leftBedRoomZone = { leftUp: { X: 11, Y: 2 }, rightDown: { X: 13, Y: 11 } };

const leftBedRoomTilesZone = { leftUp: { X: 13, Y: 2 }, rightDown: { X: 13, Y: 10 } };


const rightBedRoomZone = { leftUp: { X: 25, Y: 2 }, rightDown: { X: 27, Y: 11 } };

const rightBedRoomTilesZone = { leftUp: { X: 25, Y: 2 }, rightDown: { X: 25, Y: 10 } };

function BedRoomZoneCheck(player, params, areaInfo) {
    SendText("这里是修女们的寝床，踏入那狭小的房间后便会被包入茧中，迎来一日的安眠.", player);
}

function BedRoomTilesZoneSleep(player, params, areaInfo) {
    if (player.sleeping == true) {
        SendText("已经入眠.", player);
        return;
    }
    if (globalInfo.phase != 1) {
        SendText("当前时间无法睡眠.", player);
        return;
    }
    player.Sleep();
}

const BedRoomAreaArray = ["leftBedRoomZone", "leftBedRoomTilesZone", "rightBedRoomZone", "rightBedRoomTilesZone"]
//#endregion
//#region 告解室
const leftConfessionRoomZone = { leftUp: { X: 0, Y: 13 }, rightDown: { X: 3, Y: 25 } };

const leftConfessionRoomTilesZone = { leftUp: { X: 0, Y: 18 }, rightDown: { X: 0, Y: 24 } };

const leftConfessionRoomHiddenRoomZone = { leftUp: { X: 0, Y: 27 }, rightDown: { X: 3, Y: 28 } };


const rightConfessionRoomZone = { leftUp: { X: 35, Y: 13 }, rightDown: { X: 38, Y: 25 } };

const rightConfessionRoomTilesZone = { leftUp: { X: 38, Y: 18 }, rightDown: { X: 38, Y: 24 } };

const rightConfessionRoomHiddenRoomZone = { leftUp: { X: 35, Y: 27 }, rightDown: { X: 38, Y: 28 } };

function ConfessionRoomZoneCheck(player, params, areaInfo) {
    SendText("这里是告解室，迷途的孩子们会在这里倾诉烦恼。而你作为修女的职责就是倾听祂们的烦恼，并以双姊妹之名宽恕祂们.", player);
}

function ConfessionRoomZoneSearch(player, params, areaInfo) {
    if (player.role == "journalist") {
        player.breakedRule = true;
        SendText("鍠傦紝鍠傦紝鑳藉惉鎳傛垜璇磋瘽鍚楋紝鍚笉鎳傜殑璇濊瘯璇曟妸瀛楃缂栫爜浠?GBK 杞埌 UTF-8 璇曡瘯鐪?.", player);
    }
}

function ConfessionRoomTilesZoneConfess(player, params, areaInfo) {
    if (player.level < 3 || player.currentJob != "confess") {
        SendText("你感针刺般的头痛，或许你还没准备好倾听祂们的烦恼.", player);
        return;
    }
    var random = Math.floor(Math.random() * 10);
    switch (random) {
        case 0:
        case 1: {
            SendText("鐪熸槸鍙€滅殑瀛╁瓙.", player);
        }
            break;
        case 2:
        case 3: {
            SendText("绌挎垚杩欐牱闅鹃亾涓嶆劅鍒扮緸鑰诲悧.", player);
        }
            break;
        case 4:
        case 5: {
            SendText("鐪熸槸鐪嬪埌鏈夋剰鎬濈殑涓滆タ浜?.", player);
        }
            break;
        case 6: {
            SendText("浣犵珶鐒舵妸琚粦鏋剁殑瀛╁瓙褰撲綔绁烇紝鐪熸槸鍙瑧.", player);
        }
            break;
        case 7: {
            //提示门之密语
            SendText("宸﹁竟瑕佺敤FULL锛屽湪鍙宠竟瑕佺敤SPLIT鏉ュ紑闂紝璁板緱鎹㈡垚ASCII鐮?.", player);
        }
            break;
        case 8: {
            //提示告解室密语
            SendText("閭ｄ袱涓瀛愮殑鍚嶅瓧锛熸垜璁板緱濮愬鍙灏旓紝濡瑰鍙柉鏂岃帀鏉ョ潃.", player);
        }
            break;
        case 9: {
            SendText("对了，人类好像听不懂我们说话来着，总之可以找我用[confess inspect 目标玩家]这个指令来调查你的同类.", player);
        }
            break;
    }
    if (params.length == 0) {
        SendText("你听见迷途的孩子迷途的孩子在低语，你应当以回以宽恕的话语[confess reply].", player);
        return;
    }
    else {
        if (params[0] == "reply") {
            SendText("“鍡棷鍡ソ濂藉ソ锛岃瘽璇翠綘鏄笉鏄帇鏍规病鍦ㄥ惉鎴戣璇?”对面的气息消失了，似乎迷途的孩子离开了.", player);
            player.currentJobProcess--;
            return;
        }
        else if (params[0] = "inspect") {
            if (params.length < 2) {
                SendText("涓嶆槸锛岃鎴戣皟鏌ョ殑璇濊嚦灏戝憡璇夋垜鐩爣鍚?.", player);
                return;
            }
            else {
                var char = ChatRoomGetCharacter(params[1]);
                if (char == undefined) {
                    SendText("鎵句笉鍒拌繖涓汉鍝?.", player);
                    return;
                }
                var pl = FindPlayer(char.MemberNumber)
                if (pl == undefined) {
                    SendText("鎵句笉鍒拌繖涓汉鍝?.", player);
                    return;
                }
                SendText("杩欎釜浜虹殑韬唤鏄細" + pl.role, player);
                player.breakedRule = true;
                SendText("你向迷途的孩子祈求了信息，若被发现并检举会受到惩罚.", player);
                return;
            }

        }
    }
}

function ConfessionRoomHiddenRoomZoneCheck(player, params, areaInfo) {
    if (params.length > 0) {
        var str = areaInfo.isLeft ? "福尔" : "斯斌莉"
        if (params[0] == str) {
            ToEnd(player, "journalistSucess");
        }
        else {
            ToEnd(player, "journalistFail");
        }
    }
    else {
        SendConfessionRoomHiddenRoomText(player)
    }
}

async function SendConfessionRoomHiddenRoomText(player) {
    await SendText("“你竟然能找到这里，倒是得夸奖夸奖你”一位修女，一位没有穿着任何束缚，但是全身覆盖者黑色粘液的修女站在你的背后.", player);
    await SendText("“没错，这里就是我心爱的圣女的房间，她们成为新世界的基石而不断奉献的地方”.", player);
    await SendText("你看向那个像是棺材的装置，里面有一个女孩子，一根管道接在了她的下体，透明的管道从她的体内不断抽出黑色的粘液.", player);
    await SendText("你想要呼喊，呼喊那个在这个装置里受苦的孩子的名字[check 圣女的名字].", player);
}


const ConfessionRoomAreaArray = ["leftConfessionRoomZone", "leftConfessionRoomTilesZone", "leftConfessionRoomHiddenRoomZone", "rightConfessionRoomZone", "rightConfessionRoomTilesZone", "rightConfessionRoomHiddenRoomZone"]
//#endregion
//#region 庭院
const leftGardenZone = { leftUp: { X: 5, Y: 23 }, rightDown: { X: 18, Y: 28 } };

const leftGardenTreeZone = { leftUp: { X: 5, Y: 23 }, rightDown: { X: 18, Y: 28 } };

const leftGardenTreeHintBaseTile = { X: 18, Y: 23 };

const leftGardenWellTile = { X: 12, Y: 27 };

const leftGardenBucketTile = { X: 9, Y: 27 };

const leftGardenHiddenTile = { X: 5, Y: 27 };


const rightGardenZone = { leftUp: { X: 20, Y: 23 }, rightDown: { X: 33, Y: 28 } };

const rightGardenTreeZone = { leftUp: { X: 24, Y: 24 }, rightDown: { X: 32, Y: 25 } };

const rightGardenTreeHintBaseTile = { X: 20, Y: 23 };

const rightGardenWellTile = { X: 26, Y: 27 };

const rightGardenBucketTile = { X: 29, Y: 27 };

const rightGardenHiddenTile = { X: 33, Y: 27 };

function GardenZoneCheck(player, params, areaInfo) {
    SendText("这里是庭院，虽说是庭院但仍在室内，虽然这里充满了生命，但没有丝毫生气.", player);
}
function GardenTreeZoneGather(player, params, areaInfo) {
    if (player.currentJob != "tree") {
        SendText("你今天没有采集果实的工作，还是不要乱动了.", player);
        return;
    }
    var index = Math.floor((player.Pos.X - areaInfo.area.leftUp.X) / 2) + 1;
    var i = player.currentJobProcess.findIndex(a => a == index)
    if (i > -1) {
        SendText("你用头撞果树，从上面掉下来了漆黑的形似苹果的果实.", player);
        player.currentJobProcess.splice(i,1);
    }
    else {
        player.breakedRule = true;
        SendText("你用头撞果树，从上面掉下来了鲜红的形似苹果的果实。采集了不应采集的果实，若被发现并检举会受到惩罚.", player);
    }
}



function GardenWellTileGather(player, params, areaInfo) {
    if (player.currentJob != "water") {
        SendText("你今天没有打水的工作，还是不要乱动了.", player);
        return;
    }
    SendText("你进入水井，水逐渐吸附在了你的身上.", player);
    setTimeout(() => {
        if (IsInArea(player.Pos, areaInfo.area)) {
            player.currentJobProcess.taked = true;
            SendText("大量的水吸附在了你的身上，该倒到桶里去了.", player);
        }
        else {
            SendText("你因为乱动所以把吸附在身上的水都撒掉了.", player);
        }
    }, 5000);
}

function GardenBucketTileGather(player, params, areaInfo) {
    if (player.currentJob != "water") {
        SendText("你今天没有打水的工作，还是不要乱动了.", player);
        return;
    }
    if (player.currentJobProcess.taked == true) {
        player.currentJobProcess.taked = false;
        player.currentJobProcess.process--;
        SendText("水桶内伸出一根吸尘器头的机械触手，将你吸附在身上的水吸干净了.", player);
    }
    else {
        SendText("你现在应该去水井那里打水.", player);
    }
}

function GardenHiddenTileCheck(player, params, areaInfo) {
    SendText("你隐约听见呜咽声与喘息声，但你并不关心这些声音的来源.", player);
}

function GardenHiddenTileSearch(player, params, areaInfo) {
    if (player.role == "journalist") {
        player.breakedRule = true;
        SendText("你仔细倾听那些呜咽声与喘息声，听出了一些零星的话：“救我...找到羔羊......找到不对称的缺失”.", player);
    }
}


const GardenAreaArray = ["leftGardenZone", "leftGardenTreeZone", "leftGardenTreeHintBaseTile", "leftGardenWellTile", "leftGardenBucketTile", "leftGardenHiddenTile", "rightGardenZone" , "rightGardenTreeZone" , "rightGardenTreeHintBaseTile" , "rightGardenWellTile" , "rightGardenBucketTile" , "rightGardenHiddenTile"]
//#endregion
//#region 大厅与出生室
const leftHallZone = { leftUp: { X: 5, Y: 13 }, rightDown: { X: 13, Y: 21 } };

const leftHallEndTiles = [{ X: 8, Y: 16 }, { X: 10, Y: 16 }, { X: 8, Y: 18 }, { X: 10, Y: 18 }];

const leftBirthRoomZone = { leftUp: { X: 7, Y: 9 }, rightDown: { X: 9, Y: 11 } };

const leftBirthRoomTile = { X: 8, Y: 10 };


const rightHallZone = { leftUp: { X: 25, Y: 13 }, rightDown: { X: 33, Y: 21 } };

const rightHallEndTiles = [{ X: 28, Y: 16 }, { X: 30, Y: 16 }, { X: 28, Y: 18 }, { X: 30, Y: 18 }];

const rightBirthRoomZone = { leftUp: { X: 29, Y: 9 }, rightDown: { X: 31, Y: 11 } };

const rightBirthRoomTile = { X: 30, Y: 10 };

function HallZoneCheck(player, params, areaInfo) {
    if (areaInfo.isLeft) {
        SendText("这里是修会的大厅，北边分别是图书馆，诞生室，寝床，西边是告解室，东边是礼拜堂，南边是庭院.", player);
    }
    else {
        SendText("这里是修会的大厅，北边分别是寝床，诞生室，图书馆，西边是礼拜堂，东边是告解室，南边是庭院.", player);
    }

}

function BirthRoomZone(player, params, areaInfo) {
    SendText("这里是你作为侍奉双姊妹的修女诞生的地方，本来流动着的乳胶现在凝固着，十分坚硬.", player);
}

const HallAndBirthRoomAreaArray = ["leftHallZone", "leftBirthRoomZone", "rightHallZone", "rightBirthRoomZone"]
//#endregion
//#region 公共区域
const passageZone = { leftUp: { X: 15, Y: 13 }, rightDown: { X: 23, Y: 15 } };

function passageZoneCheck(player, params, areaInfo) {
    SendText("这里是通往礼拜堂的走廊，即使隔着大门也能感到礼拜堂内的神圣气息.", player);
}

const punishmentRoomZone = { leftUp: { X: 15, Y: 17 }, rightDown: { X: 23, Y: 19 } };

function punishmentRoomZoneCheck(player, params, areaInfo) {
    SendText("这里是惩罚室，你需要在这里不停的来回往复以悔改自身的罪过.", player);
}

const leftpunishmentRoomTiles = [{ X: 15, Y: 17 }, { X: 18, Y: 17 }, { X: 15, Y: 19 }, { X: 18, Y: 19 }]

const leftpunishmentRoomExitTile = { X: 16, Y: 21 };

const rightpunishmentRoomTiles = [{ X: 20, Y: 17 }, { X: 23, Y: 17 }, { X: 23, Y: 19 }, { X: 20, Y: 19 }]

const rightpunishmentRoomExitTile = { X: 22, Y: 21 };

const punishmentRoomHiddenDoorTiles = [{ X: 18, Y: 20 }, { X: 20, Y: 20 }];

const NightOpenBarsTiles = [{ X: 19, Y: 25 }];

function punishmentRoomTilesMoved(player, areaInfo) {
    var index = player.punishmentCircleTlieList.findIndex(a => a.X == player.Pos.X && a.Y == player.Pos.Y)
    if (index == -1) {
        player.punishmentCircleTlieList.push(Object.assign({}, player.Pos))
    }
    if (player.punishmentCircleTlieList.length >= 4) {
        SendText("你“跑”完了一圈.", player);
        player.punishmentCircleTlieList = [];
        player.punishmentCircleCount++;
        if (player.punishmentCircleCount >= player.punishmentCircleTarget) {
            player.punishing = false;
            SendText("你的惩罚结束了，希望你能就此悔改.", player);
            if (areaInfo.isLeft) {
                Teleport(player, leftpunishmentRoomExitTile.X, leftpunishmentRoomExitTile.Y);
            }
            else {
                Teleport(player, rightpunishmentRoomExitTile.X, rightpunishmentRoomExitTile.Y);
            }
        }
    }
}

const punishmentRoomHiddenRoomZone = { leftUp: { X: 18, Y: 21 }, rightDown: { X: 20, Y: 21 } };

function punishmentRoomHiddenRoomZoneCheck(player, params, areaInfo) {
    SendText("惩罚室内竟然有这样的地方，这个隐藏房间的正中像是供奉般的摆着一个金色的钥匙.", player);
}
const churchZone = { leftUp: { X: 15, Y: 1 }, rightDown: { X: 23, Y: 11 } };

const leftchurchTPTile = { X: 17, Y: 8 };

const rightchurchTPTile = { X: 21, Y: 8 };

function churchZoneCheck(player, params, areaInfo) {
    SendText("这里是双姊妹修会的礼拜堂，在双姊妹圣像严厉的视线之下，一切隐瞒与罪恶都无处遁形.", player);
}

function churchZoneReport(player, params, areaInfo) {

    if (player.role == "manic") {
        SendText("狂人身份不可进行检举.", player);
        return;
    }
    if (params.length > 0) {
        var char = ChatRoomGetCharacter(params[0]);
        if (char == undefined) {
            SendText("未找到检举目标.", player);
            return;
        }
        var pl = FindPlayer(char)
        if (pl == undefined) {
            SendText("未找到检举目标.", player);
            return;
        }
        var rep = reportedPlayer.find((a) => a.MemberNumber == pl.MemberNumber)
        if (rep == undefined) {
            rep = { MemberNumber: pl.MemberNumber, reporter: [] };
            reportedPlayer.push(rep);
        }
        rep.reporter.push(player.MemberNumber);
        SendText("你将检举" + params[0], player);
    }
}

const leftHintTile = { X: 4, Y: 1 };

const rightHintTile = { X: 32, Y: 23 };
function HintTileCheck(player, params, areaInfo) {
    SendText("这里让你感到有些违和，但你却说不出哪里有问题.", player);
}

function HintTileSearch(player, params, areaInfo) {
    if (player.role == "journalist") {
        player.breakedRule = true;
        if (areaInfo.isLeft) {
            SendText("仔细检查后，你确定这里曾经挂过什么物件，正当你思考之时却听到一阵若有若无的低语“福尔，我刻着全之环的孩子，你是我的福音.”", player);
        }
        else {
            SendText("仔细检查后，你确定这里曾经挂过什么物件，正当你思考之时却听到一阵若有若无的低语“斯斌莉，我刻着缺之环的孩子，你是我的福音.”", player);
        }
    }
}

const startTile = { X: 19, Y: 32 };

const statueTiles = [{ X: 8, Y: 2 }, { X: 9, Y: 2 }, { X: 7, Y: 5 }, { X: 8, Y: 5 }, { X: 3, Y: 14 }, { X: 18, Y: 2 }, { X: 20, Y: 2 }, { X: 29, Y: 2 }, { X: 30, Y: 2 }, { X: 30, Y: 5 }, { X: 31, Y: 5 }, { X: 35, Y: 14 }]

function statueTilesMoved(player, areaInfo) {
    if (player.level <= 2) {
        SendText("擅自踏入双姊妹像下方乃是不敬之举，以双姊妹之名施以惩戒.", player);
        player.Punish();
    }

}

const miscAreaArray = ["passageZone", "punishmentRoomZone", "leftpunishmentRoomTiles", "rightpunishmentRoomTiles", "punishmentRoomHiddenRoomZone", "churchZone", "leftHintTile", "rightHintTile", "startTile", "statueTiles"]
var allAreaArray = [].concat(baseAreaArray, LibraryAreaArray, BedRoomAreaArray, ConfessionRoomAreaArray, GardenAreaArray, HallAndBirthRoomAreaArray, miscAreaArray)


//#endregion
//#region 主体事件处理
ChatRoomMessageAdditionDict["RubberChurch"] = function (SenderCharacter, msg, data) { ChatRoomMessageRubberChurch(SenderCharacter, msg, data) }
ChatRoomSyncMapDataeAdditionDict["RubberChurch"] = function (SenderCharacter) { PlayerMoved(SenderCharacter) }

async function ChatRoomMessageRubberChurch(SenderCharacter, msg, data) {
    if (SenderCharacter.MemberNumber == Player.MemberNumber) {
        return;
    }
    if ((data.Type == "Action") && (msg.startsWith("ServerEnter"))) {
        Teleport(SenderCharacter, 19, 37);
        ShowWelcomeMessage(SenderCharacter);
    }
    else if ((msg.startsWith("ServerLeave")) || (msg.startsWith("ServerDisconnect")) || (msg.startsWith("ServerBan")) || (msg.startsWith("ServerKick"))) {
        var index = playingPlayer.findIndex((a) => a.MemberNumber == SenderCharacter.MemberNumber)
        if (index >= 0) {
            playingPlayer.splice(index, 1);
        }
        index = endedPlayer[0].findIndex((a) => a.MemberNumber == SenderCharacter.MemberNumber)
        if (index >= 0) {
            endedPlayer[0].splice(index, 1);
        }
        index = endedPlayer[1].findIndex((a) => a.MemberNumber == SenderCharacter.MemberNumber)
        if (index >= 0) {
            endedPlayer[1].splice(index, 1);
        }
        index = globalInfo.cagePlayers.findIndex((a) => a.MemberNumber == SenderCharacter.MemberNumber)
        if (index >= 0) {
            globalInfo.cagePlayers[1].splice(index, 1);
        }
    }
    else if ((data.Type == "Hidden" && msg.startsWith("ChatRoomBot"))) {
        console.log(SenderCharacter.Name + " cmd:" + msg)
        var params = msg.toLowerCase().substring(11).trim().split(' ');
        var player = FindPlayer(SenderCharacter);
        if (player != undefined) {
            var cancel = true;
            if (params.length > 0) {
                switch (params[0]) {
                    case "think": {
                        player.Think();
                    }
                        break;
                    case "contact": {
                        if (player.role == "lamb" && params.length > 1) {
                            var target = playingPlayer.find((a) => a.MemberNumber != player.MemberNumber && a.role == "lamb");
                            if (target != undefined) {
                                var searchList = [];
                                var pName = SenderCharacter.Name;
                                var pNick = SenderCharacter.Nickname == '' ? null : SenderCharacter.Nickname;
                                var targetChar = ChatRoomGetCharacter(target.MemberNumber);
                                var tName = targetChar.Name;
                                var tNick = targetChar.Nickname == '' ? null : targetChar.Nickname;
                                searchList.push(pName, pNick, player.MemberNumber.toString(), tName, tNick, target.MemberNumber);
                                var result = false;
                                for (var str of searchList) {
                                    if (params[1].indexOf(str) > -1) {
                                        result = true;
                                        break;
                                    }
                                }
                                if (result) {
                                    SendText("擅用通灵乃是不敬之举，以双姊妹之名施以惩戒", player);
                                    player.Punish();
                                }
                                else {
                                    SendText("接收到另一个羔羊的消息：" + params[1], target);
                                }
                            }
                            else {
                                SendText("你没有感受到你的姐妹，或许她还没有到来", player);
                            }
                        }
                    }
                        break;
                    case "messup": {
                        if (player.role == "manic" && params.length > 1) {
                            var targetC = ChatRoomGetCharacter(params[1]);
                            if (targetC == undefined) return;
                            var target = FindPlayer(targetC.MemberNumber);
                            if (target == undefined) return;
                            player.breakedRule = true;
                            SendText("你破坏了她的劳动成果，若被发现并检举会受到惩罚.", player);
                            target.AddJobProcess();
                        }
                    }
                        break;
                    default: {
                        cancel = false;
                    }
                        break;
                }
            }
            if (cancel == false) {
                DoCommands(player, params)
            }
        }
        else {
            if (params.length > 0 && params[0] == "start") {
                PlayerStart(SenderCharacter);
            }
        }
    }
    else if ((data.Type == "Emote") || (data.Type == "Action") || (data.Type == "Chat")) {
        var player = FindPlayer(SenderCharacter);
        if (player != undefined) {
            player.Talked();
        }
        
    }
}
//处理玩家指令
async function DoCommands(player, params) {
    if (params.length > 0) {
        var inArea = FindAreaByPos(player.Pos)
        if (Object.keys(inArea).length > 0) {
            //若存在位于有对应指令的tile上，则不执行zone的指令
            var hasTile = false;
            for (var i in inArea) {
                if (inArea[i].IsZone == false && mapEvents[i].Cmd[params[0]] != undefined) {
                    hasTile = true;
                    break;
                }
            }
            for (var i in inArea) {
                if (hasTile && inArea[i].IsZone) continue;
                var cmd = mapEvents[i].Cmd[params[0]];
                if (cmd != undefined) {
                    SendText("-----------------------------------.", player);

                    cmd(player, params.slice(1), inArea[i]);
                }
            }
        }
    }
}


//初始化所有地图事件
async function InitmapEvents() {
    mapEvents = {};
    for (var i = 0; i < allAreaArray.length; i++) {
        var area = allAreaArray[i];
        var isL = true;
        var areaSub = area;
        if (area.startsWith("left")) {
            areaSub = area.substring(4);
        }
        if (area.startsWith("right")) {
            areaSub = area.substring(5);
            isL = false;
        }
        var isZ = false;
        if (area.endsWith("Zone")) {
            isZ = true;
        }
        if (mapEvents[areaSub] == undefined) {
            mapEvents[areaSub] = { AreaInfo: [], Moved: null, Cmd: {} };
        }
        try {
            var a = eval(area);
            mapEvents[areaSub].AreaInfo.push({ area: a, isLeft: isL, IsZone: isZ });
        }
        catch {

        }
        var movedfunc = window[areaSub + "Moved"];
        if (movedfunc != undefined) {
            mapEvents[areaSub].Moved = movedfunc;
        }
        for (var cmd in CmdWords) {
            var cmdfunc = window[areaSub + CmdWords[cmd]];
            if (cmdfunc != undefined) {
                mapEvents[areaSub].Cmd[CmdWords[cmd].toLowerCase()] = cmdfunc;
            }
        }
    }
}



async function InitBot() {
    WearEquips(Player, baseEquips.concat(leftEquips).concat(lv3Hat).concat(EndEquips))
    ServerSend("ChatRoomCharacterMapDataUpdate", { Pos: { X: 18, Y: 35 } });
    Player.MapData.Pos = { X: 18, Y: 35 };

    Player.Description = desc
    // end of description
    ServerSend("AccountUpdate", { Description: Player.Description });
    ChatRoomCharacterUpdate(Player);
}

async function InitRoom() {

    //重置房间
    ChatRoomData.MapData = map;
    ChatRoomData.Description = "[BOT]密室逃生第六部 乳胶教会";
    ServerSend("ChatRoomAdmin", { MemberNumber: Player.ID, Room: ChatRoomGetSettings(ChatRoomData), Action: "Update" });
}
//#endregion 
//#region 地图检测
//玩家移动后处理
async function PlayerMoved(SenderCharacter) {
    if (ChatRoomCharacterIsAdmin(SenderCharacter)) {
        return;
    }
    var player = FindPlayer(SenderCharacter);
    if (player != undefined) {
        for (var evKey in mapEvents) {
            if (mapEvents[evKey].Moved == null) continue;
            for (var aKey in mapEvents[evKey].AreaInfo) {
                if (IsInArea(SenderCharacter.MapData.Pos, mapEvents[evKey].AreaInfo[aKey].area)) {
                    mapEvents[evKey].Moved(player, mapEvents[evKey].AreaInfo[aKey])
                }
            }
            
        }
        player.Moved()
    }
    
}
function IsInArea(Pos, Area) {
    var isIn = false;
    if (Area.X != undefined) {
        isIn = IsAtTile(Pos, Area);
    }
    else if (Area.leftUp != undefined) {
        isIn = IsInZone(Pos, Area);
    }
    else if (Area instanceof Array) {
        isIn = IsAtTileArray(Pos, Area);
    }
    return isIn;
}

function IsInZone(Pos, Zone) {
    return (Pos.X >= Zone.leftUp.X && Pos.Y >= Zone.leftUp.Y && Pos.X <= Zone.rightDown.X && Pos.Y <= Zone.rightDown.Y)
}

function IsAtTile(Pos, Tile) {
    return (Pos.X == Tile.X && Pos.Y == Tile.Y)
}
function IsAtTileArray(Pos, Tiles) {
    for (var tile of Tiles) {
        if (IsAtTile(Pos, tile)) {
            return true;
        }
    }
    return false;
}

function FindAreaByPos(Pos) {
    var inArea = {};
    for (var i in mapEvents) {
        for (var j in mapEvents[i].AreaInfo) {
            if (IsInArea(Pos, mapEvents[i].AreaInfo[j].area) == true) {
                inArea[i] = mapEvents[i].AreaInfo[j];
            }
        }
    }
    return inArea;
}
//#endregion
//#region 数据与房间事件

class PlayerInfo{
    constructor(sender) {
        this.MemberNumber = sender.MemberNumber;

        var isL = true;
        var leftCount = 0;
        var rightCount = 0;
        var sumPlayers = playingPlayer.concat(waitingPlayer);
        for (var i of sumPlayers) {
            if (i.isLeft) {
                leftCount++;
            }
            else {
                rightCount++;
            }
        }
        isL = leftCount < rightCount;
        this.isLeft = isL;

        //完成当天任务，检举其他玩家获得2exp，每3exp升1级，升至4级时结局
        this.exp = 0;
        this.level = 1;
        this.levelStr = "";
        this.daySpend = 0;
        /** 
         * 职业 达到等级2获得职业，完成职业任务执行职业结局
         * 虔信徒believer：经过10天或达到lv4
         * 狂信徒zealot：检举3次成功 最多2人
         * 异端信徒heresy：总共三天在本方对方图书馆检查过 最多1人 调查会提高图书馆的密语获得概率
         * 羔羊lamb：献祭自身成功打开隐藏门，2人，会连续产生，且会互相认识，特殊指令可以秘密通信 门打开后会持续两天
         * 疯人manic：使任意一个玩家连续三天未完成工作 最多1人 特殊指令干扰，但不可检举其他玩家
         * 记者journalist：进入祷告室下方密室并回答对应密语 最多1人 特殊指令搜查，3到4级需要5点经验
         */
        this.role = "default";
        this.roleProcess = null;

        //工作，lv1采集，打水 深色草坪提示缺少某物的不对称处有提示，lv2图书馆，概率获得门之密语与告解室密语，lv3告解室，可调查玩家职业
        this.currentJob = "none";
        this.currentJobProcess = null;

        //惩罚跑圈，每次惩罚多跑十圈，第4次受罚结局，每进入四个不重复的检查点视为跑一圈，晚上惩罚室的栏杆会消失
        this.punishing = false;
        this.punishmentCircleCount = 0;
        this.punishmentCircleTarget = 0;
        this.punishmentCircleTlieList = [];

        //一天最多发言lv*3+2次，超出惩罚
        this.talkCount = 0;

        //夜晚外出，进入对方区域，未完成工作,疯人与记者的特殊指令视为打破规则，收到检举则进行惩罚
        this.breakedRule = false;

        //指定检举的玩家，若检举成功+1exp，失败进行惩罚
        this.reportPlayer = "";

        this.stepCount = 0;
        this.tired = false;

        this.sleeping = false;
    }
    get Pos() {
        var result = ChatRoomGetCharacter(this.MemberNumber);
        if (result != undefined) {
            return ChatRoomGetCharacter(this.MemberNumber).MapData.Pos;
        }
        return { X: 0, Y: 0 };
    }
    async Think() {
        SendText("当前状态：", this);
        var levelStr = "见习修女";
        switch (this.level) {
            case 1: {
                levelStr = "见习修女";
            }
                break;
            case 2: {
                levelStr = "正式修女";
            }
                break;
            case 3: {
                levelStr = "高阶修女";
            }
                break;
            case 4: {
                levelStr = this.levelStr;
            }
                break;
        }
        SendText("所属修会：" + (this.isLeft ? "全环修会" : "缺环修会") + "，职务：" + levelStr + "，虔诚：" + this.exp + "，天数：" + this.daySpend, this);
        var jobStr = "暂无工作";
        var jobDesc = "等待下一天布置工作"
        switch (this.currentJob) {
            case "tree": {
                jobStr = "采集果实";
                var str = this.currentJobProcess.toString();
                jobDesc = "前往庭院，分别采集" + str + "编号的果树，在果树处使用采集[gather]指令(左侧果树为1号，从左到右编号依次增加)."
            }
                break;
            case "water": {
                jobStr = "打水";
                jobDesc = "前往庭院，在水井处使用采集[gather]指令并等待数秒钟汲水，然后前往水桶处使用采集[gather]指令,还需" + this.currentJobProcess.process + "次."
            }
                break;
            case "library": {
                jobStr = "整理藏书";
                jobDesc = "前往图书馆，使用拿取[take]与放置[put]指令整理藏书，在书桌处使用检查[check]指令查看进度(左上书架为1号，从左到右，从上往下编号依次增加)."
            }
                break;
            case "confess": {
                jobStr = "告解";
                jobDesc = "前往告解室，在房间内使用告解[confess reply]指令进行告解,还需" + this.currentJobProcess + "次."
            }
                break;
        }
        SendText("今日工作：" + jobStr + "," + jobDesc, this);
        var roleStr = "暂无身份";
        var roleDesc = "晋升至正式修女以获得身份."
        switch (this.role) {
            case "believer": {
                roleStr = "虔信徒";
                roleDesc = "总计生活十天，积累生活十天或晋升至高阶修女后的下一等级."
            }
                break;
            case "zealot": {
                roleStr = "狂信徒";
                roleDesc = "进行三次成功的检举."
            }
                break;
            case "heresy": {
                roleStr = "异端信徒";
                roleDesc = "前往图书馆，在该修会与对方修会的图书馆各检查[check]三次[每个图书馆每天只可检查一次]."
            }
                break;
            case "lamb": {
                roleStr = "羔羊";
                roleDesc = "完成指令：找到你的姐妹但不得相认，在文字宫殿的深处献上门之密语，为苦修者打开通往■■姊妹的大门而献身。可使用沟通[contact 发送内容]指令与另一个羔羊进行通信，但是不可以在沟通指令中输入自己或对方的名称，昵称，玩家编号，否则会进入坏结局."
            }
                break;
            case "manic": {
                roleStr = "疯人";
                roleDesc = "使一名玩家连续三天未能完成工作，可使用干扰[messup 目标玩家]指令干扰一名玩家的工作进度，但被发现并检举的话会受到惩罚。且检举指令不可用."
            }
                break;
            case "journalist": {
                roleStr = "记者";
                roleDesc = "发现双姊妹修会的秘密，可在特殊地点使用调查[search]指令获取隐藏信息，但被发现并检举的话会受到惩罚。且提升至高阶修女后的下一等级需要经验增加."
            }
                break;
        }
        SendText("身份：" + roleStr + ",目标：" + roleDesc, this);
    }

    async Sleep() {
        this.sleeping = true;
        await WearEquips(this, SleepEquips);
        SendText("诞生时的茧再一次覆盖了你的身体，紧勒般的包裹感让你的意识逐渐模糊，但是却无法入眠，于是你在半梦半醒的恍惚中缓缓的消解一天的疲劳", this);
        var lvUpReq = (this.level == 3 && this.role == "journalist") ? 5 : 3;
        if (this.exp >= lvUpReq) {
            this.exp = 0;
            this.level++;
            SendText("恍惚间，你听到一阵声音：“你的虔诚天地可见，吾将赐予你晋升的荣光”", this);
            if (this.level == 4) {
                ToEnd(this, this.role == "believer" ? "believer" : "lv4");
                return;
            }
            if (this.level == 2) {
                await this.SetRamdomRole();
            }
            WearEquips(this, hatList[this.level - 1]);
            
        }
        if (this.role == "believer" && this.daySpend >= 10) {
            ToEnd(this, "believer");
        }
    }

    async WakeUp() {
        this.sleeping = false;
        this.talkCount = 0;
        this.stepCount = 0;
        this.tired = false;
        var char = ChatRoomGetCharacter(this.MemberNumber);
        var boots = char.Appearance.find((a) => a.Asset.Name == "BalletMittens" && a.Asset.Group.Name == "ItemBoots");
        if (boots != undefined) {
            boots.Property.TypeRecord.p = 1;
        }
        //var head = char.Appearance.find((a) => a.Asset.Name == "DroneMask" && a.Asset.Group.Name == "ItemHead");
        //if (head != undefined) {
        //    head.Property.TypeRecord.s = 1;
        //}
        CharacterRefresh(char);
        ChatRoomCharacterUpdate(char);
        SendText("茧又一次随着你的疲惫褪去，又是新的一天", this);
        RemoveEquips(this, SleepEquips);

    }

    async Punish() {
        if (this.sleeping) {
            this.WakeUp();
        }
        if (this.punishing = true && globalInfo.cagePlayers.find((a) => a.MemberNumber == this.MemberNumber) != undefined) {
            SendText("你试图主动让自己被丢进惩罚室来逃出这个笼子，但这完全无济于事.", this);
            return;
        }
        this.punishmentCircleTarget += 10;
        if (this.punishmentCircleTarget < 40) {
            this.punishing = true;
            var targetTile = this.isLeft ? leftpunishmentRoomTiles[0] : rightpunishmentRoomTiles[0];
            SendText("你的惩罚是在这里“跑”" + this.punishmentCircleTarget + "圈来悔过.", this);
            Teleport(this, targetTile.X, targetTile.Y);
        }
        else {
            ToEnd(this, "punish");
        }
    }

    async SetRamdomRole() {
        var zealot = 0;
        var heresy = 0;
        var lamb = 0;
        var anotherLamb = null;
        var manic = 0;
        var journalist = 0;
        var result = "believer";
        for (var p of playingPlayer) {
            switch (p.role) {
                case "zealot": {
                    zealot++;
                }
                    break;
                case "heresy": {
                    heresy++;
                }
                    break;
                case "lamb": {
                    lamb++;
                    anotherLamb = p;
                }
                    break;
                case "manic": {
                    manic++;
                }
                    break;
                case "journalist": {
                    journalist++;
                }
                    break;
            }
        }
        if (lamb == 1) {
            result = "lamb"
        }
        else {
            var randomList = [];
            if (zealot < 2) {
                randomList.push("zealot");
            }
            if (heresy < 1) {
                randomList.push("heresy");
            }
            if (lamb < 1) {
                randomList.push("lamb");
            }
            if (manic < 1) {
                randomList.push("manic");
            }
            if (journalist < 1) {
                randomList.push("journalist");
            }
            var believer = Math.floor(randomList.length / 2 + 1);
            for (var i = 0; i < believer; i++) {
                randomList.push("believer");
            }
            result = randomList[Math.floor(Math.random() * randomList.length)];
        }
        this.role = result;
        await this.SendRoleText(result, anotherLamb);
    }

    async SendRoleText(result, anotherLamb) {
        await SendText("------------------------------.", this);
        await SendText("在经过几天这样奇特的生活后，你发现你的内心竟十分的平静，随后你意识到正是这里治愈了你那被尘世摧残得千疮百孔的灵魂.", this);
        await SendText("这样无论是行走，抓握，甚至是呼吸都需要费尽心力的生活中，你反而有机会让自己的思维喘口气.", this);
        switch (result) {
            case "believer": {
                await SendText("经过一段思想斗争后，你正式决定放弃你以前的生活，正式加入双姊妹修会.", this);
                await SendText("获得身份：虔信徒，积累生活十天或晋升至高阶修女后的下一等级以观看身份结局.", this);
            }
                break;
            case "zealot": {
                this.roleProcess = 0;
                await SendText("随后你感到从内心升起一阵炙热，这正是发现人生使命时的激昂感，这双姊妹修会是神圣的，高贵的，不容侵犯的.", this);
                await SendText("但是这修会中的修女并非绝对的虔诚，那便是绝对的不虔诚，你要找到并将这些渎神者全部送进惩罚室接受改造，这是你不容动摇的使命.", this);
                await SendText("获得身份：狂信徒，进行三次成功的检举以观看身份结局.", this);
            }
                break;
            case "heresy": {
                this.roleProcess = [];
                await SendText("你深切的感受到了双姊妹的慈悲与正义，这值得你让你用生命去侍奉，但一阵漆黑的想法浮现出你的脑海.", this);
                await SendText("那至高无上的双姊妹又是否愿意分享她们的福音呢？这个想法让你感到羞愧但又挥之不去，你需要更多的关于双姊妹的知识来抹去这一想法，这座修会的图书馆或许有你想要的.", this);
                await SendText("获得身份：异端信徒，在该修会与对方修会的图书馆各检查[check]三次以观看身份结局[每个图书馆每天只可检查一次].", this);
            }
                break;
            case "lamb": {
                await SendText("经过一段思想斗争后，你正式决定放弃你以前的生活，正式加入双姊妹修会.", this);
                await SendText("但一阵声音浮现在你的脑海“找到你的姐妹但不得相认，在文字宫殿的深处献上门之密语，为苦修者打开通往■■姊妹的大门而献身”.", this);
                await SendText("你无法抵抗这阵声音的力量从而屈服下来，这命令便成了你人生的唯一目的", this);
                await SendText("获得身份：羔羊，完成那阵声音的指令以观看身份结局.", this);
                if (anotherLamb == null) {
                    await SendText("当前无搭档，等待下一个玩家获得羔羊身份后可使用沟通[contact 发送内容]指令进行通信，但是不可以在沟通指令中输入自己或对方的名称，昵称，玩家编号，否则会进入坏结局.", this);
                }
                else {
                    await SendText("可使用沟通[contact 发送内容]指令与另一个羔羊进行通信，但是不可以在沟通指令中输入自己或对方的名称，昵称，玩家编号，否则会进入坏结局.", this);
                }
            }
                break;
            case "manic": {
                this.roleProcess = [];
                await SendText("恐慌，你只感到恐慌，对即将失去的过去的人生感到恐慌，随后你拼命的挣扎，反抗，但都无济于事.", this);
                await SendText("随后是歇斯底里，再随后是异常的冷静，你过去的人生再也回不来了，能做的只有毁掉在这里享受人生的混蛋的人生.", this);
                await SendText("获得身份：疯人，使一名玩家连续三天未能完成工作以观看身份结局.", this);
                await SendText("可使用干扰[messup]指令干扰一名玩家的工作进度，但被发现并检举的话会受到惩罚。且检举指令不可用.", this);
            }
                break;
            case "journalist": {
                await SendText("你惊觉自己遗忘了使命如此之久，也对个修会对人的洗脑之强感到恐怖.", this);
                await SendText("你是一名，或者说曾是一名记者，在调查连环失踪案的过程中被绑架到了这里，不过在案子中失踪的人员都在这里成了修女，当然包括你.", this);
                await SendText("或许逃出升天已经不可能了，但你至少打算解开这起案子的最后一个疑点，远在数年前失踪的双胞胎姐妹是否与这个修会有关，得出结论后再彻底沉沦也不迟.", this);
                await SendText("获得身份：记者，发现双姊妹修会的秘密以观看身份结局.", this);
                await SendText("可在特殊地点使用调查[search]指令获取隐藏信息，但被发现并检举的话会受到惩罚。且提升至高阶修女后的下一等级需要经验增加.", this);
            }
                break;
        }
    }

    SetJob() {
        var result = "tree";
        var randomList = [];
        switch (this.level) {
            case 1: {
                randomList = ["tree", "water"];
            }
                break;
            case 2: {
                randomList = ["tree", "water", "library", "library", "library"];
            }
                break;
            case 3: {
                randomList = ["library", "library", "confess", "confess", "confess"];
            }
                break;
        }
        result = randomList[Math.floor(Math.random() * randomList.length)];
        this.currentJob = result;
        this.SendJobTextAndInitJob(result)
    }
    async SendJobTextAndInitJob(result) {
        await SendText("------------------------------.", this);
        switch (result) {
            case "tree": {
                this.currentJobProcess = [];
                for (var i = 0; i < 10; i++) {
                    this.currentJobProcess.push(Math.floor(Math.random() * (5) + 1))
                }
                await SendText("你今日的工作为采集庭院内树木的果实.", this);
            }
                break;
            case "water": {
                this.currentJobProcess = { taked: false, process: 5 };
                await SendText("你今日的工作为在庭院内打水.", this);
            }
                break;
            case "library": {
                this.currentJobProcess = { taked: -1, targets: [] };
                for (var i = 0; i < 5; i++) {
                    this.currentJobProcess.targets.push({ from: Math.floor(Math.random() * (12) + 1), to: Math.floor(Math.random() * (12) + 1) });
                }
                await SendText("你今日的工作为整理图书馆内的藏书.", this);
            }
                break;
            case "confess": {
                this.currentJobProcess = 10;
                await SendText("你今日的工作为在告解室为迷途之人指引前路.", this);
            }
                break;
        }
        await SendText("详细工作方法可在[think]指令内查看.", this);

    }

    AddJobProcess() {
        switch (this.currentJob) {
            case "tree": {
                this.currentJobProcess.push(Math.floor(Math.random() * (5 + 1)))
            }
                break;
            case "water": {
                this.currentJobProcess.process++;
            }
                break;
            case "library": {
                this.currentJobProcess.targets.push({ from: Math.floor(Math.random() * (12 + 1)), to: Math.floor(Math.random() * (12 + 1)) });
 }
                break;
            case "confess": {
                this.currentJobProcess++;
            }
                break;
        }
    }

    IsJobDone() {
        switch (this.currentJob) {
            case "none": {
                return true;
            }
            case "tree": {
                return this.currentJobProcess.length <= 0;
            }
                break;
            case "water": {
                return this.currentJobProcess.process <= 0;
            }
                break;
            case "library": {
                return this.currentJobProcess.targets <= 0;
              }
                break;
            case "confess": {
                return this.currentJobProcess <= 0;
            }
                break;
        }
        return true;
    }

    async ResetEuqips() {
        await RemoveClothes(ChatRoomGetCharacter(this.MemberNumber));
        await RemoveRestrains(ChatRoomGetCharacter(this.MemberNumber));
        await WearEquips(this, baseEquips.concat(this.isLeft ? leftEquips : rightEquips).concat(hatList[this.level - 1]))
    }

    async StartGame() {
        await SendText("有一阵失重感袭来，象征这你新生活的开始.", this)
        var target = this.isLeft ? leftBirthRoomTile : rightBirthRoomTile;
        await Teleport(this, target.X, target.Y);
    }

    async Moved() {
        this.stepCount++;
        if (this.stepCount > 200 && this.tired == false) {
            this.tired = true;
            var char = ChatRoomGetCharacter(this.MemberNumber);
            var boots = char.Appearance.find((a) => a.Asset.Name == "BalletMittens" && a.Asset.Group.Name == "ItemBoots");
            if (boots != undefined) {
                boots.Property.TypeRecord.p = 2;
            }
            //var head = char.Appearance.find((a) => a.Asset.Name == "DroneMask" && a.Asset.Group.Name == "ItemHead");
            //if (head != undefined) {
            //    head.Property.TypeRecord.s = 0;
            //}
            CharacterRefresh(char);
            ChatRoomCharacterUpdate(char);
            SendText("你感到十分的疲惫，哪怕就连向前跳一小步都困难无比，眼皮就像灌了铅，你现在唯一的欲望就是回到寝床进入那温暖而紧致的茧好好的休息", this);
        }
    }

    async Talked() {
        this.talkCount++;
        if (this.talkCount >= this.level * 3 + 2) {
            SendText("过多的言语乃是不敬之举，以双姊妹之名施以惩戒.", this)
            this.Punish();
        }
    }
}

class GlobalInfo {
    constructor() {
        this.messageFoundBoost = false;
        this.doorOpen = false;
        this.phase = 0;
        this.timeoutId = -1;
        this.timeValue = 1;
        this.lastTime = new Date();
        this.cagePlayers = [];
    }

    async PhaseEvent(autoNext = true) {
        while (waitingPlayer.length > 0 && this.phase != 3) {
            var player = waitingPlayer.pop();
            player.StartGame();
            playingPlayer.push(player);
            await sleep(10);
        }
        console.log("toPhase:" + this.phase);
        this.lastTime = new Date();
        switch (this.phase) {
            //检举结束，前往卧室 90s
            case 0: {
                if (autoNext == true) {
                    this.timeoutId = setTimeout(() => {
                        this.phase++;
                        globalInfo.PhaseEvent();
                    }, 90 * this.timeValue * 1000);
                }


                globalInfo.messageFoundBoost = false;
                for (var reported of reportedPlayer) {
                    var p = FindPlayer(reported)
                    if (p != undefined) {
                        if (p.breakedRule) {
                            for (var reporter of reported.reporter) {
                                try {
                                    var r = FindPlayer(reporter)
                                    if (r != undefined) {
                                        SendText("检举成功", r);
                                        if (r.role == "zealot") {
                                            r.roleProcess++;
                                            if (r.roleProcess >= 3) {
                                                ToEnd(r, "zealot");
                                            }
                                        }
                                        r.exp++;
                                    }
                                }
                                catch {
                                    FindNullAndRemove(player);
                                }
                            }
                            SendText("违规行为被检举，以双姊妹之名施以惩戒.", p);
                            p.Punish();
                        }
                    }
                }
                reportedPlayer = []
                for (var player of playingPlayer) {
                    player.breakedRule = false;
                    if (player.punishing) continue;
                    SendText("当前时间为黄昏，每日礼拜已结束，立即前往寝床休息.该阶段时间60秒", player);
                }
                
            }
                break;
            //卧室睡眠 180s
            case 1: {
                if (autoNext == true) {
                    this.timeoutId = setTimeout(() => {
                        this.phase++;
                        globalInfo.PhaseEvent();
                    }, 180 * this.timeValue * 1000);
                }


                var opers = [];
                for (var v of NightOpenBarsTiles) {
                    opers.push({ X: v.X, Y: v.Y, Id: BlankObjId })
                }
                SetMapObjs(opers);
                for (var player of playingPlayer) {
                    try {
                        SendText("当前时间为夜晚，未在寝床内的修女需进入寝床使用[sleep]指令睡眠.该阶段时间180秒", player);
                        if (player.punishing) continue;
                        if (IsInArea(player.Pos, leftBedRoomTilesZone) || IsInArea(player.Pos, rightBedRoomTilesZone)) {
                            player.Sleep();
                        }
                    }
                    catch {
                        FindNullAndRemove(player);
                    }
                }
                

            }
                break;
            //日间活动 360s
            case 2: {
                if (autoNext == true) {
                    this.timeoutId = setTimeout(() => {
                        this.phase++;
                        globalInfo.PhaseEvent();
                    }, 360 * this.timeValue * 1000);
                }


                try {
                    for (var player of globalInfo.cagePlayers) {
                        if (player.role == "lamb") {
                            ToEnd(player, "lamb");
                        }
                        else {
                            ToEnd(player, "cage");
                        }
                    }
                }
                catch {
                    FindNullAndRemove(player);
                }
                globalInfo.cagePlayers = [];
                var opers = [];
                for (var v of punishmentRoomHiddenDoorTiles) {
                    opers.push({ X: v.X, Y: v.Y, Id: BlankObjId })
                }
                for (var v of NightOpenBarsTiles) {
                    opers.push({ X: v.X, Y: v.Y, Id: IronBarsObjId })
                }
                SetMapObjs(opers);
                for (var player of playingPlayer) {
                    try {
                        player.daySpend++;
                        SendText("当前时间为上午.该阶段时间360秒", player);
                        if (player.punishing) continue;
                        player.SetJob();
                        if (IsInArea(player.Pos, leftBedRoomTilesZone) || IsInArea(player.Pos, rightBedRoomTilesZone)) {
                            player.WakeUp();
                        }
                    }
                    catch {
                        FindNullAndRemove(player);
                    }
                }
                

            }
                break;
            //礼拜检举 120s
            case 3: {
                if (autoNext == true) {
                    this.timeoutId = setTimeout(() => {
                        this.phase = 0;
                        globalInfo.PhaseEvent();
                    }, 120 * this.timeValue * 1000);
                }


                var jobUndoneList = [];
                for (var player of playingPlayer) {
                    try {
                        SendText("当前时间为下午.该阶段时间120秒", player);
                        if (player.punishing) continue;
                        if (player.IsJobDone() == false) {
                            jobUndoneList.push(player.MemberNumber);
                            SendText("你未能完成今日工作，若被发现并检举会受到惩罚", player);
                        }
                        else {
                            player.exp++;
                        }
                        if (player.isLeft) {
                            Teleport(player, leftchurchTPTile.X, leftchurchTPTile.Y);
                        }
                        else {
                            Teleport(player, rightchurchTPTile.X, rightchurchTPTile.Y);
                        }
                        SendText("现在开始礼拜，若有需发现违规行为，使用检举[report 检举目标]指令来进行检举", player);
                    }
                    catch {
                        FindNullAndRemove(player);
                    }
                }
                var manic = playingPlayer.find((a) => a.role == "manic");
                if (manic != undefined) {
                    manic.roleProcess.push(jobUndoneList);
                    if (manic.roleProcess.length >= 4) {
                        manic.roleProcess.splice(0, 1);
                    }
                    if (manic.roleProcess.length >= 3) {
                        for (var i of manic.roleProcess[0]) {
                            if (manic.roleProcess[1].find((a) => a == i) != undefined &&
                                manic.roleProcess[2].find((a) => a == i) != undefined) {
                                ToEnd(manic, "manic");
                                break;
                            }
                        }
                    }
                    
                }
                

            }
                break;
        }
    }

    async StopPhase() {
        if (this.timeoutId != -1) {
            clearTimeout(this.timeoutId);
        }
    }

    async NextPhase() {
        this.StopPhase();
        this.phase++;
        if (this.phase == 4) this.phase = 0;
        this.PhaseEvent(false);
    }
}

function FindPlayer(sender) {
    return playingPlayer.find((a) => a.MemberNumber == sender || a.MemberNumber == sender.MemberNumber);
}



async function ShowWelcomeMessage(sender) {
    SendText("在回家路上，你被一个奇怪的人塞了一张传单，上面写着双姊妹修会这个宗教的介绍，以及一些脱离俗世迎来新生的画大饼", sender);
    SendText("你本来是对那个新兴宗教的传单没有兴趣的，但是现在你明显感觉到了异常。这是你在回家过程中第三次经过这个修道院了，实在太可疑了所以你打算干脆进去看看。[请查看bot的在线描述来获取开始游戏方式]", sender);
    SendText("This is a Chinese room,make sure you can read Chinese before start", sender);
}

async function PlayerStart(sender) {
    if (playingPlayer.length >= 10) {
        SendText("已满员，请稍等", sender);
        return;
    }
    if (IsInArea(sender.MapData.Pos, startTile)) {
        if (sender.AllowedInteractions > 2) {
            SendText("[需要调低 玩家权限 才能游玩]", sender);
            return;
        }
        RemoveClothes(sender);
        RemoveRestrains(sender);
        var player = new PlayerInfo(sender);
        await WearEquips(player, SleepEquips);
        await SendText("你意识到你刚刚作了个大死，黑色的黏糊液体迅速将你完全包裹住并硬化，强大的压迫力让你无法挣脱.", sender);
        Teleport(player, 13, 36);
        await SendText("随着一阵失重感和冲击，你似乎掉到了什么地方.", sender);
        await WearEquips(player, baseEquips.concat(player.isLeft ? leftEquips : rightEquips).concat(lv1Hat));
        await SendText("就在快要因为这个包裹里缺乏空气快要窒息时，你感到似乎有个面罩贴在了你的脸上，虽然这让你恢复了呼吸能力，但是吸入的气体却让你整个身体都感到燥热.", sender);
        await SendText("虽然是有东西勒在了你的胸前和下体，随着逐渐的勒紧你感到越来越痛苦，但刹那间，痛苦消失了，随之消失的是你对身体的敏感带的感知.", sender);
        await SendText("又有什么东西开始拉动你的手臂到背后折叠起来成了后手观音的姿势，让你的手臂再也无法活动分毫，双腿也被固定在了一块无法分开.", sender);
        await RemoveEquips(player, SleepEquips); 
        await SendText("包裹逐渐收紧，紧贴在你的皮肤上，同时多余的部分聚集在你的脚上，形成了一个圆球.", sender);
        await SendText("你试图挣扎，但就连摔倒都做不到，脚上沉重的圆球起到了不倒翁的配重的作用。你现在除了缓慢的小跳步以外什么都做不到.", sender);
        var timeDiff = new Date().getTime() - globalInfo.lastTime.getTime();
        var phaseTime = 0;
        switch (globalInfo.phase) { 
            //黄昏阶段可加入
            case 0: {
                player.StartGame();
                playingPlayer.push(player);
                return;
            }
                break;
            //夜晚阶段不加入
            case 1: {
                phaseTime = 180 * globalInfo.timeValue * 1000;
            }
                break;
            //白天阶段可加入
            case 2: {
                player.StartGame();
                playingPlayer.push(player);
                return;
            }
                break;
            //下午阶段不加入
            case 3: {
                phaseTime = 120 * globalInfo.timeValue * 1000;
            }
        }
        var time = Math.floor((phaseTime - timeDiff) / 1000);
        await SendText("[请稍等至当前阶段结束即可加入游戏,预计等待" + time + "秒].", sender);
        waitingPlayer.push(player);
        
    }

}
async function ToEnd(player, param) {
    
    player.punishing = false;
    var i = player.isLeft ? 0 : 1;
    var list = endedPlayer[i];

    i = playingPlayer.findIndex((a) =>  player.MemberNumber == a.MemberNumber );
    if (i == -1) return;
    playingPlayer.splice(i, 1);

    if (list.length >= 4) {
        var out = list.pop();
        Teleport(out, 19, 37);
        WearEquips(out, OutEquips);
        SendText("从结果上来说，教会倒塌了，物理意义上的。你重新获得了自由，但自由并不包括你的身体，你只能钻进一个斗篷，祈求路人别看到你这奇怪的样子", out)
    }
    var target = { X: 19, Y: 37 };
    for (var tile of (player.isLeft ? leftHallEndTiles : rightHallEndTiles)) {
        var isUsed = false;
        for (var p of list) {
            if (tile.X == p.Pos && tile.Y == p.Pos) {
                isUsed = true;
            }
        }
        if (isUsed == false) {
            target = tile;
            break;
        }
    }
    list.splice(0, 0, player);
    WearEquips(player, EndEquips);
    Teleport(player, target.X, target.Y);
    ShowEndText(player, param);
    var char = ChatRoomGetCharacter(player.MemberNumber);
    console.log(char.Name + "toend:" + param);
}
async function ShowEndText(player, param) {
    switch (param) {
        case "lv4": {
            await SendText("待你醒来之后，发现自己完全动弹不得，随后你发现自己被关在一个贴合你身体曲线的架子里.", player);
            await SendText("“你的虔诚吾已知晓，在此稍待，待吾降临，来做吾的近侍。”你被脑海里的声音压垮，只能遵从与祂.", player);
            await SendText("于是你在大厅的墙壁的隔层里等待，日复一日，年复一年，等待福音到来.", player);
            await SendText("结局：上升之路(在达到高阶修女等级后再晋升一个等级).", player);
        }
            break;
        case "punish": {
            await SendText("你本以为又要去惩罚室里“跑步”，但你回过神来发现自己完全动弹不得，随后你发现自己被关在一个贴合你身体曲线的架子里.", player);
            await SendText("随后有一道粉色的激光照在你小腹的位置上，你已经失去的性快感如潮水般涌回，但就当你差一步达到高潮时，那爆发般的快感却没有到来.", player);
            await SendText("快感不断积累，你几乎被焦躁感逼疯，拼命的晃动使架子发出格拉格拉的声音，但就是无法达到快感的盈满，在这无尽的折磨中你开始忏悔你的罪行.", player);
            await SendText("结局：受难之路(第四次受到惩罚).", player);
        }
            break;
        case "believer": {
            await SendText("日复一日，日复一又日，你的生活一丝不变，你的虔诚也一丝不变.", player);
            await SendText("某日，一位修女，一位没有穿着任何束缚，但是全身覆盖者黑色粘液的修女来找你.", player);
            await SendText("你不记得祂说了什么，但祂亲自带你到大厅内的隔层，亲自为你着上了圣洁的构造，你的修行将从这里迎来新的开始.", player);
            await SendText("结局：虔诚之路(虔信徒身份结局).", player);
        }
            break;
        case "zealot": {
            await SendText("你观察着周围的每一个细枝末节，深恐错过了任何一个亵渎之举，无数的不虔诚的同道被你送进了惩罚室，有的再也没有出来.", player);
            await SendText("某日，一位修女，一位没有穿着任何束缚，但是全身覆盖者黑色粘液的修女来找你.", player);
            await SendText("现在你虽然在圣洁的构造内动弹不得，但是你依旧紧盯着每一个经过的同道，监督着她们虔诚.", player);
            await SendText("结局：狂热之路(狂信徒身份结局).", player);
        }
            break;
        case "heresy": {
            await SendText("“是的，你找到了我的笔记，也得知了我亲爱的圣女的来历”你回过头去，一位修女，一位没有穿着任何束缚，但是全身覆盖者黑色粘液的修女在你背后.", player);
            await SendText("你瞬间意识到了她是圣女受难的原因，你本想反抗她，但是你在她面前毫无还手之力.", player);
            await SendText("如今关在了这个个构造内，但你从未停止思考，思考拯救圣女的方法，思考拯救修会的方法.", player);
            await SendText("结局：沉思之路(异端信徒身份结局).", player);
        }
            break;
        case "lamb": {
            await SendText("虽然完成了使命，你感到有些不甘.", player);
            await SendText("如果你能坚持得再久一点，或许能为命令里提到的苦修者争取更多的时间.", player);
            await SendText("你的意识逐渐消散，你用者最后的意识感谢了你的姐妹，随后便深深的睡去.", player);
            await SendText("结局：牺牲之路(羔羊身份结局).", player);
        }
        case "cage": {
            await SendText("直到失去意识为止，你不知道你为什么要进到笼子里.", player);
            await SendText("结局：迷茫之路(进入图书馆隐藏房间的笼子).", player);
        }
            break;
        case "manic": {
            await SendText("虽然看不到其他修女的脸，但你确定她们的表情大多是惊恐，惊恐于你的狂笑.", player);
            await SendText("因为双手双腿都无法像一个人类一样活动，她们以笨拙的动作包围了你，你也以笨拙的动作反击.", player);
            await SendText("最后你被关在了大厅后的隔间，但你的狂笑不会停下，她们也永远无法摆脱着墙后瘆人的笑声.", player);
            await SendText("结局：绝望之路(疯人身份结局).", player);
        }
            break;
        case "journalistSucess": {
            await SendText("“我真的很惊讶，你能调查到这些.......所以呢？你又能如何？”,但那个修女没有看到那个受苦的女孩的眼睛微微张开了.", player);
            await SendText("你笑了，正是真相揭开时这样的舒畅感，你才会选择这个职业，不，不是修女，而是记者，追求真相的记者.", player);
            await SendText("你吐了那个偏执的宗教家一口唾沫，虽然唾沫被挡在了你的面罩下，但确实羞辱到了她。会有某人刺向她的死穴，你在被砌进墙里前这么想.", player);
            await SendText("结局：探求之路(记者身份成功结局).", player);
        }
            break;
        case "journalistFail": {
            await SendText("“呵，看来只是我白紧张了一场”", player);
            await SendText("你确定离真相只差一步之遥了，若是你能够找到那个受苦的孩子的名字的话.", player);
            await SendText("你吐了那个偏执的宗教家一口唾沫，但是唾沫被挡在了你的面罩下。你在被砌进墙里后只能感到无尽的后悔.", player);
            await SendText("结局：折戟之路(记者身份失败结局).", player);
        }
            break;
    }
}
//#endregion

function tpalltodef() {
    for (var a of ChatRoomCharacter) {
        if (ChatRoomCharacterIsAdmin(a)) {
            continue;
        }
        Teleport(a, 19, 37);
    }
}

function FindNullAndRemove(player) {
    if (ChatRoomGetCharacter(player) == undefined) {
        var i = playingPlayer.findIndex((a) => a.MemberNumber == player.MemberNumber)
        if (i > -1) {
            playingPlayer.splice(i, 1);
            console.log("removed:" + player.MemberNumber)
        }
    }
}

var mapEvents = {};
var waitingPlayer = [];
var playingPlayer = [];
var endedPlayer = [[], []];
var reportedPlayer = [];
var globalInfo = new GlobalInfo();
InitRoom();
tpalltodef();
InitBot();
InitmapEvents();
globalInfo.PhaseEvent();



